#!/usr/bin/env bash

if [[ -z $OPY_ENV_PREFIX ]]; then
OPY_ENV_PREFIX=opy
fi

if [[ -z $OPY_PYTHON_VERSION ]]; then
#OPY_PYTHON_VERSION=`python --version 2>&1 | awk '{print($2);}'`
OPY_PYTHON_VERSION=3.6.2
fi

PYENV_CMD=`PATH=~/.pyenv/bin/:$PATH which pyenv`
PLATFORM=`platform`

if [[ -z $PYENV_CMD ]]; then
    echo "Not found pyenv command."

    if [[ "$PLATFORM" == "MacOSX" ]]; then
        BREW_CMD=`which brew`
        if [[ -z $BREW ]]; then
            echo "Not found brew command."
            ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
        fi

        BREW_CMD=`which brew`
        if [[ -z $BREW ]]; then
            exit 1
        fi

        echo "Install pyenv from brew command."
        brew update
        brew install pyenv
        brew install pyenv-virtualenv
    else
        GIT_CMD=`which git`
        if [[ -z $GIT_CMD ]]; then
            echo "Not found git command."
            exit 1
        fi

        echo "Install pyenv from pyenv-installer (see: https://github.com/pyenv/pyenv-installer)"
        curl -L https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash
    fi

    PYENV_CMD=`PATH=~/.pyenv/bin/:$PATH which pyenv`
    if [[ -z $PYENV_CMD ]]; then
        exit 1
    fi
fi

USER_NAME=`id -u -n`
OPY_PYTHON_VERSION_REGEX=`echo $OPY_PYTHON_VERSION | sed 's/\./\\\\./g'`
OPY_ENV_NAME="__${USER_NAME}_${OPY_ENV_PREFIX}_opy_${OPY_PYTHON_VERSION}__"
OPY_ENV_NAME_REGEX=`echo $OPY_ENV_NAME | sed 's/\./\\\\./g'`

export PATH="~/.pyenv/bin:$PATH"
eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"

FIND_PYTHON_ENV=`pyenv versions | sed 's/*//g' | awk '{print($1);}' | egrep "^${OPY_PYTHON_VERSION_REGEX}$"`
if [[ -z $FIND_PYTHON_ENV ]]; then
    echo "Not found $OPY_PYTHON_VERSION pyenv."
    if [[ "$PLATFORM" == "MacOSX" ]]; then
        PYTHON_CONFIGURE_OPTS="--enable-framework" pyenv install $OPY_PYTHON_VERSION
    else
        PYTHON_CONFIGURE_OPTS="--enable-shared" pyenv install $OPY_PYTHON_VERSION
    fi
fi

FIND_OPY_ENV=`pyenv versions | sed 's/*//g' | awk '{print($1);}' | egrep "^$OPY_ENV_NAME_REGEX$"`
#echo "FIND_OPY_ENV: $FIND_OPY_ENV"
if [[ -z $FIND_OPY_ENV ]]; then
    echo "Not found $OPY_ENV_NAME pyenv."
    pyenv virtualenv "$OPY_PYTHON_VERSION" "$OPY_ENV_NAME"
fi

CURRENT_PYENV_VERSION=`pyenv version | awk '{ print($1); }'`
#echo "CURRENT_PYENV_VERSION: $CURRENT_PYENV_VERSION"
if [[ "$CURRENT_PYENV_VERSION" != "$OPY_ENV_NAME" ]]; then
    pyenv shell $OPY_ENV_NAME
else
    pyenv activate $OPY_ENV_NAME
    #pyenv deactivate
fi

echo "[OSOM Python Environment]"
echo "* Python version: $(python --version 2>&1)"
echo "* Python executable: $(which python)"
echo "* Pyenv version: $(pyenv version | awk '{print($1);}')"

