#!/usr/bin/env bash

if ! command -v opm-version &> /dev/null; then
PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" || exit; pwd):$PATH"
fi

USAGE="
Usage: ${BASH_SOURCE[0]} [options] ...

Available options are:
  -h, --help    Print this message.
  -D            Use default settings
  --            Stop handling options.
  ...           Command-line arguments for flake8.
"

FLAKE8_CONFIG="
[flake8]
max-line-length = 88
extend-ignore =
    E203, W503
exclude =
    */.git,
    */.venv
filename = *.py
format=%(path)s:%(row)d:%(col)d: %(code)s %(text)s
"

function opy_flake8_main
{
    local default=0

    while [[ -n $1 ]]; do
        case $1 in
        -h|--help)
            echo "$USAGE"
            exit 0
            ;;
        -D)
            default=1
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
        esac
    done

    local args=()
    if [[ $default -ne 0 ]]; then
        args+=("--config" <(echo "$FLAKE8_CONFIG"))
    fi

    opy-checked-install flake8
    opy -m flake8 "${args[@]}" "$@"
}

opy_flake8_main "$@"
