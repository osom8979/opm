#!/usr/bin/env bash

if ! command -v opm-version &> /dev/null; then
PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" || exit; pwd):$PATH"
fi

DEFAULT_SERVICE="opm"

USAGE="
Usage: opm-keys-keyring [options] {get|set|rm} key

Commands:
  get       Obtain the value from keyring.
  set       Save the value to keyring.
  rm        Remove key

Available options are:
  -h, --help              Print this message.
  --service {name}        Keyring service name (default: '$DEFAULT_SERVICE')
  --                      Skip handling options
"

function print_usage
{
    echo "$USAGE"
}

function opm_keys_keyring_get
{
    local service=$1
    local key=$2

    if [[ -z "$key" ]]; then
        opm-println-error "The key argument is required."
        return 1
    fi

    if ! opy-keyring get "$service" "$key"; then
        opm-println-error "Failed to get key from keyring."
        return 1
    fi
}

function opm_keys_keyring_set
{
    local service=$1
    local key=$2
    local value=$3

    if [[ -z "$key" ]]; then
        opm-println-error "The key argument is required."
        return 1
    fi

    if [[ -n "$value" ]]; then
        if ! echo "$value" | opy-keyring set "$service" "$key"; then
            opm-println-error "Failed to set key in keyring."
            return 1
        fi
    else
        if ! opy-keyring set "$service" "$key"; then
            opm-println-error "Failed to set key in keyring."
            return 1
        fi
    fi
}

function opm_keys_keyring_rm
{
    local service=$1
    local key=$2

    if [[ -z "$key" ]]; then
        opm-println-error "The key argument is required."
        return 1
    fi

    if ! opy-keyring del "$service" "$key"; then
        opm-println-error "Failed to remove key from keyring."
        return 1
    fi
}

function opm_keys_keyring_main
{
    local service="$DEFAULT_SERVICE"

    while [[ -n $1 ]]; do
        case $1 in
        -h|--help)
            print_usage
            return 0
            ;;
        --service)
            service="$2"
            shift 2
            ;;
        --service=*)
            service="${1#*=}"
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
        esac
    done

    if [[ $# -eq 0 ]]; then
        print_usage
        return 0
    fi

    local op=$1
    shift

    case $op in
    g|get)
        opm_keys_keyring_get "$service" "$1"
        ;;
    s|set)
        opm_keys_keyring_set "$service" "$1" "$2"
        ;;
    d|del|delete|r|rm|remove)
        opm_keys_keyring_rm "$service" "$1"
        ;;
    *)
        print_usage
        return 1
    esac
}

opm_keys_keyring_main "$@"
