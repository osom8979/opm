#!/usr/bin/env bash

if ! command -v opm-version &> /dev/null; then
PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" || exit; pwd):$PATH"
fi

DEFAULT_TIMEOUT=3

USAGE_MESSAGE="
Check if ports are open on a remote host using netcat.

  Usage: opm-nc-port-check [options] <host> <port> [port...]

Available options are:
  -h, --help                Print this message.
  -w, --timeout=seconds     Connection timeout (default: ${DEFAULT_TIMEOUT}s).
  -q, --quiet               Suppress verbose output (exit code only).
  --                        Skip handling options.

Examples:
  opm-nc-port-check google.com 80
  opm-nc-port-check 192.168.1.100 22 80 443
  opm-nc-port-check -w 5 hostname 8080
"

function print_usage
{
    echo "$USAGE_MESSAGE"
}

function opm_nc_port_check_main
{
    local timeout=$DEFAULT_TIMEOUT
    local quiet_mode=0
    local verbose_flag="-v"

    while [[ -n $1 ]]; do
        case $1 in
        -h|--help)
            print_usage
            return 0
            ;;
        -w)
            timeout=$2
            shift 2
            ;;
        --timeout=*)
            timeout=${1:10}
            shift
            ;;
        -q|--quiet)
            quiet_mode=1
            verbose_flag=""
            shift
            ;;
        --)
            shift
            break
            ;;
        -*)
            opm-println-error "Unknown option: $1"
            print_usage
            return 1
            ;;
        *)
            break
            ;;
        esac
    done

    if [[ $# -lt 2 ]]; then
        opm-println-error "Missing required arguments: host and port"
        print_usage
        return 1
    fi

    local host=$1
    shift

    if ! command -v nc &> /dev/null; then
        opm-println-error "netcat (nc) is not installed"
        return 1
    fi

    local exit_code=0
    local all_success=1

    for port in "$@"; do
        if [[ ! "$port" =~ ^[0-9]+$ ]]; then
            opm-println-error "Invalid port number: $port"
            exit_code=1
            all_success=0
            continue
        fi

        if nc -z $verbose_flag -w "$timeout" "$host" "$port" 2>&1; then
            if [[ $quiet_mode -eq 0 && -z "$verbose_flag" ]]; then
                echo "Port $port is open"
            fi
        else
            exit_code=$?
            all_success=0
            if [[ $quiet_mode -eq 0 && -z "$verbose_flag" ]]; then
                echo "Port $port is closed"
            fi
        fi
    done

    return $exit_code
}

opm_nc_port_check_main "$@"
