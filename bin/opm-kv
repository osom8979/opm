#!/usr/bin/env bash

if ! command -v opm-version &> /dev/null; then
PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" || exit; pwd):$PATH"
fi

# shellcheck disable=SC2155
STORAGE_DIR=$(opm-home)/var/keys

USAGE="
Usage: opm-kv [options] {get|set|rm|ls} key [value]

Available options are:
  -h, --help        Print this message.
  -s {dir}, --storage {dir}
                    Change storage directory
  --                Skip handling options
"

function print_usage
{
    echo "$USAGE"
}

function opm_kv_get
{
    local storage=$1
    local key=$2
    local file="$storage/$key"

    if [[ -z "$key" ]]; then
        opm-println-error "The key argument is required."
        return 1
    fi

    if [[ ! -f "$file" ]]; then
        opm-println-error "Not found key file."
        return 1
    fi

    if ! opy-sagecipher decrypt "$(cat "$file")"; then
        opm-println-error "Decryption failed."
        return 1
    fi
}

function opm_kv_set
{
    local storage=$1
    local key=$2
    local value=$3
    local file="$storage/$key"

    if [[ -z "$key" ]]; then
        opm-println-error "The key argument is required."
        return 1
    fi

    if [[ -z "$value" ]]; then
        if [[ ! -t 0 ]]; then
            read -r -u 0 value
        fi
        if [[ -z "$value" ]]; then
            opm-println-error "The value argument is required."
            return 1
        fi
    fi

    if [[ -f "$file" ]]; then
        opm-println-error "This key file already exists."
        return 1
    fi

    if ! opy-sagecipher encrypt "$value" > "$file"; then
        opm-println-error "Encryption failed."
        return $?
    fi
}

function opm_kv_rm
{
    local storage=$1
    local key=$2
    local file="$storage/$key"

    if [[ -z "$key" ]]; then
        opm-println-error "The key argument is required."
        return 1
    fi

    if [[ ! -f "$file" ]]; then
        opm-println-error "Not found key file."
        return 1
    fi

    rm "$file"
}

function opm_kv_ls
{
    find "$1" -type f -printf "%f\n" | grep -v -E '^\..*'
}

function opm_kv_main
{
    local storage="$STORAGE_DIR"

    while [[ -n $1 ]]; do
        case $1 in
        -h|--help)
            print_usage
            return 0
            ;;
        -s|--storage)
            storage="$2"
            shift 2
            ;;
        --storage=*)
            storage="${1:10}"
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
        esac
    done

    if [[ ! -d "$storage" ]]; then
        opm-println-error "Not found storage directory: '$storage'"
        return 1
    fi

    local op=$1
    shift

    case $op in
    get)
        opm_kv_get "$storage" "$1"
        ;;
    set)
        opm_kv_set "$storage" "$1" "$2"
        ;;
    del|delete|rm|remove)
        opm_kv_rm "$storage" "$1"
        ;;
    ls|list)
        opm_kv_ls "$storage"
        ;;
    *)
        print_usage
        return 1
    esac
}

opm_kv_main "$@"
