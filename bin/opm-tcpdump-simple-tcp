#!/usr/bin/env bash

if ! command -v opm-version &> /dev/null; then
PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" || exit; pwd):$PATH"
fi

if ! command -v tcpdump &> /dev/null; then
    opm-println-error "Not found tcpdump executable"
    exit 1
fi

DEFAULT_INTERFACE=eno1
DEFAULT_ROTATE_SECONDS=3600

if command -v nmcli &> /dev/null; then
    DEFAULT_INTERFACE=$(nmcli -t -f DEVICE,TYPE,STATE device status | grep --color=never -E ':(ethernet|wifi):connected' | cut -d: -f1 | head -1)
else
    opm-println-warn "Not found tcpdump executable"
fi

USAGE="
Usage: ${BASH_SOURCE[0]} [options] [interface]

Capture TCP packets and save to pcap files with hourly rotation.

Available options are:
  -h, --help     Print this message.
  -G SECONDS     Rotate dump file every SECONDS (default: $DEFAULT_ROTATE_SECONDS)
  -t             Don't print timestamp
  -tt            Print Unix epoch timestamp
  -v             Verbose output
  -vv            More verbose output
  -x             Print packet data in hex
  -xx            Print packet data in hex (including link level header)
  -X             Print packet data in hex and ASCII
  -XX            Print packet data in hex and ASCII (including link level header)
  --             Skip handling options

Arguments:
  interface      Network interface (default: auto-detect via nmcli)

Output:
  Files are saved as: <interface>_%Y-%m-%d_%H-%M.pcap

Default interface: $DEFAULT_INTERFACE
"

function print_usage
{
    echo "$USAGE"
}

function tcpdump_simple_tcp_main
{
    local tcpdump_opts=()
    local rotate_seconds=$DEFAULT_ROTATE_SECONDS

    while [[ -n $1 ]]; do
        case $1 in
        -h|--help)
            print_usage
            return 0
            ;;
        -G)
            rotate_seconds=$2
            shift 2
            ;;
        -t|-tt|-v|-vv|-x|-xx|-X|-XX)
            tcpdump_opts+=("$1")
            shift
            ;;
        --)
            shift
            break
            ;;
        -*)
            opm-println-error -s "Invalid flag: $1"
            return 1
            ;;
        *)
            break
            ;;
        esac
    done

    local interface=${1:-$DEFAULT_INTERFACE}

    if [[ -z "$interface" ]]; then
        opm-println-error "No network interface found"
        return 1
    fi

    if [[ $(id -u) -ne 0 ]]; then
        opm-println-error "Please run as root"
        exit 1
    fi

    tcpdump -i "$interface" -w "${interface}_%Y-%m-%d_%H-%M.pcap" -G "$rotate_seconds" "${tcpdump_opts[@]}" tcp
}

tcpdump_simple_tcp_main "$@"
