#!/usr/bin/env bash

if ! command -v opm-version &> /dev/null; then
PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" || exit; pwd):$PATH"
fi

if [[ $(id -u) -eq 0 ]]; then
    echo "Please do not run as root" 1>&2
    exit 1
fi

if ! command -v nmap &> /dev/null; then
    opm-println-error "Not found nmap executable"
    exit 1
fi

USAGE="
Usage: ${BASH_SOURCE[0]} [options] CIDR PORT

Available options are:
  -h, --help     Print this message.
  --             Skip handling options

CIDR Format:
  IP/MaskNumber

CIDR Example:
  10.0.0.0/16
  192.168.0.0/24

PORT Example:
  22
  1-200
"

function print_usage
{
    echo "$USAGE"
}

function nmap_scan_network_main
{
    while [[ -n $1 ]]; do
        case $1 in
        -h|--help)
            print_usage
            return 0
            ;;
        --)
            shift
            break
            ;;
        -*)
            opm-println-error -s "Invalid flag: $1"
            return 1
            ;;
        *)
            break
            ;;
        esac
    done

    local cidr=$1
    local ports=$2

    if [[ -z "$cidr" ]]; then
        opm-println-error "The CIDR argument is required."
        return 1
    fi

    if [[ -z "$ports" ]]; then
        opm-println-error "The PORTS argument is required."
        return 1
    fi

    nmap --open -p "$ports" "$cidr"
}

nmap_scan_network_main "$@"
